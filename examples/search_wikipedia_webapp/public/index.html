<!doctype html>
<html>
<head>
<title>Wikipedia pages local search</title>
<style>
.result {
  margin: 0.5em 0;
}
</style>
</head>
<body>
<script src="//cdnjs.cloudflare.com/ajax/libs/mithril/0.2.0/mithril.js"></script>
<script>
var search = {};

search.Result = function(data) {
  this.title = m.prop(data && data.title || "");
  this.text = m.prop(data && data.text || "");
};
search.results = m.prop([]);

search.vm = {
  searchWord: m.prop(""),
  matchedCount: m.prop(0)
};

search.controller = function() {
  this.search = function() {
    var url = "/search";
    var q = search.vm.searchWord();
    if (q !== "") {
      url += "?q=" + encodeURIComponent("_key:@" + q + " OR text:@" + q);
    }
    return m.request({method: "GET", url: url, type: search.Result,
      unwrapSuccess: function(response) {
        search.vm.matchedCount(response.matchedCount);
        return response.results;
      }
    })
    .then(search.results)
    .then(m.redraw);
  }
};

search.view = function(ctrl) {
  var vm = search.vm;
  var wikipediaLink = function(title) {
    return "https://ja.wikipedia.org/wiki/" + encodeURIComponent(title());
  };
  return m(".search", [
    m("input", {
      onchange: m.withAttr("value", vm.searchWord),
      value: vm.searchWord()
    }),
    m("button", {onclick: ctrl.search}, "Search"),
    m(".matchedCount", [
      m("label", "Matched count: "),
      m("span", vm.matchedCount())
    ]),
    search.results().map(function(result, index) {
      return m(".result", [
        m(".title", [
          m("a[href=" + wikipediaLink(result.title) + "][target=_blank]",
            result.title())
        ]),
        m(".text", result.text())
      ])
    })
  ]);
};

m.mount(document.body, {controller: search.controller, view: search.view});
</script>
<body>
</html>
